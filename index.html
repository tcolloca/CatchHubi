<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch Hubi!</title>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}})();const N={en:{play:"Play!",language_label:"Language",difficulty_label:"Difficulty",game_intro:"Hmmm, so tasty all these carrots and cheeses that I'll eat!",game_intro_2:"Hubi has stolen your food and taken them to the haunted house. Find the magic door and open it to wake him up and recover your food!",player_selection_intro:"Select the players that will be playing this game. When ready, press the help button.",player_selected:"Great! {0} is joining the game.",player_already_in_game:"{0} is already in the game.",both_rabbit_and_mouse_required:"Both a rabbit and a mouse are required to start a game.",select_first_player:"Select a player to be the first one.",first_player_selected:"Great! {0} is going to go first.",first_player_not_selected:"Please select a player to be the first one.",first_player_must_be_in_game:"The first player must be in the game.",ask_where_to:"Dear {0}, in which direction would you like to move?",invalid_move:"That's not a valid move.",bonus_move:"You already know this! You get an extra move.",wall:"Wall.",external_wall:"Oopla! That's an external wall.",mouse_hole:"Mouse hole.",rabbit_window:"Rabbit window.",free_passage:"Free passage.",magic_door:"Closed magic door.",opened_magic_door:"Opened magic door.",magic_door_opened:"The magic door has been opened!",can_pass_through:"You can pass through.",cannot_pass_through:"You cannot pass through.",green_rabbit:"green rabbit",red_mouse:"red mouse",yellow_mouse:"yellow mouse",blue_rabbit:"blue rabbit",host:"host",hubi:"hubi",owl:"an owl",frog:"a frog",millipede:"a millipede",bat:"a bat",black_owl:"a black owl",white_owl:"a white owl",black_frog:"a black frog",white_frog:"a white frog",black_millipede:"a black millipede",white_millipede:"a white millipede",black_bat:"a black bat",white_bat:"a white bat",green:"green",red:"red",yellow:"yellow",blue:"blue",ghost_hint:"Hubi is in a room with {0}.",door_hint:"There's a magic door between a room with {0} and a room with {1}.",player_position:"{0} is in a room with {1} closer to {2} on the {3} room.",hubi_awake:"Huh... What's that sound that has just woke me up?",hubi_moved:"Haha! You'll never catch me!",ghost_moved:"Hubi has changed rooms, hurry to find him!",hubi_found_by_one_player:"Oh, no! You've found me! But you need another player to catch me!",hubi_found_by_two_players:"Oh, no! You've caught me! You can take your food, I've had fun too!",sunset:"The sun is setting soon, and it's getting dark...",evening:"The sun has set, and it's dark outside...",close_to_midnight:"It's getting close to midnight!",midnight:"It's midnight!",game_won:"You've won!",game_over:"You've lost!"},es:{play:"¬°Jugar!",language_label:"Idioma",difficulty_label:"Dificultad",game_intro:"Hmmm, ¬°qu√© rico todas estas zanahorias y quesos que voy a comer!",game_intro_2:"Hubi ha robado tu comida y la ha llevado a su casa embrujada. Encuentra la puerta m√°gica y abrela para despertar a Hubi y recuperar tu comida!",player_selection_intro:"Selecciona los jugadores que participar√°n en esta partida. Cuando est√©s listo, pulsa el bot√≥n de ayuda.",player_selected:"¬°Genial! {0} se une a la partida.",player_already_in_game:"{0} ya est√° en la partida.",both_rabbit_and_mouse_required:"Se requiere tanto un conejo como un rat√≥n para empezar la partida.",select_first_player:"Selecciona un jugador para que sea el primero.",first_player_selected:"¬°Genial! {0} ir√° primero.",first_player_not_selected:"Por favor, selecciona un jugador para que sea el primero.",first_player_must_be_in_game:"El primer jugador debe estar en la partida.",ask_where_to:"Querido {0}, ¬øEn qu√© direcci√≥n te gustar√≠a moverte?",invalid_move:"Ese no es un movimiento v√°lido.",bonus_move:"¬°Ya lo sabes! Tienes un movimiento extra.",wall:"Muro.",external_wall:"¬°Oopla! Ese es un muro exterior.",mouse_hole:"Agujero de rat√≥n.",rabbit_window:"Ventana de conejo.",free_passage:"Paso libre.",magic_door:"Puerta m√°gica cerrada.",opened_magic_door:"Puerta m√°gica abierta.",magic_door_opened:"¬°La puerta m√°gica se ha abierto!",can_pass_through:"Puedes pasar.",cannot_pass_through:"No puedes pasar.",green_rabbit:"conejo verde",red_mouse:"rat√≥n rojo",yellow_mouse:"rat√≥n amarillo",blue_rabbit:"conejo azul",host:"anfitri√≥n",hubi:"hubi",owl:"un b√∫ho",frog:"una rana",millipede:"un milpi√©s",bat:"un murci√©lago",black_owl:"un b√∫ho negro",white_owl:"un b√∫ho blanco",black_frog:"una rana negra",white_frog:"una rana blanca",black_millipede:"un ciempi√©s negro",white_millipede:"un ciempi√©s blanco",black_bat:"un murci√©lago negro",white_bat:"un murci√©lago blanco",green:"verde",red:"roja",yellow:"amarilla",blue:"azul",ghost_hint:"Hubi est√° en una habitaci√≥n con {0}.",door_hint:"Hay una puerta m√°gica entre una habitaci√≥n con {0} y una habitaci√≥n con {1}.",player_position:"{0} est√° en una habitaci√≥n con {1} cercano a {2} en la habitaci√≥n {3}.",hubi_awake:"Uhh, ¬øQu√© es ese ruido que me ha despertado?",hubi_moved:"Ha! Nunca me atrapar√°s!",ghost_moved:"Hubi se ha movido a otra habitaci√≥n, ¬°Ap√∫rate para encontrarlo!",hubi_found_by_one_player:"¬°Oh, no! ¬°Me has encontrado! ¬°Pero necesitas a alguien mas para atraparme!",hubi_found_by_two_players:"¬°Oh, no! ¬°Me han atrapado! Tomen su comida, me he divertido much igual.",sunset:"El sol est√° por ponerse, y est√° empezando a oscurecer...",evening:"El sol se ha puesto, y est√° oscuro afuera...",close_to_midnight:"¬°Ya falta poco para la medianoche!",midnight:"¬°Es medianoche!",game_won:"¬°Han ganado!",game_over:"¬°Han perdido!"}};class D{currentAudio;waitingForAudios;interrupted;constructor(){this.currentAudio=null,this.waitingForAudios=0,this.interrupted=!1}async playFile(e,t){return new Promise(i=>{this.stopAll();const a=new Audio(`audio/${e}/${t}`);this.currentAudio=a;let s=!1;const r=o=>{s||(s=!0,this.currentAudio=null,console.warn(`[AudioManager] failed: ${t} (source: ${o})`),i(!1))};a.onended=()=>{console.log(`[AudioManager] finished: ${t}`),!s&&(s=!0,this.currentAudio=null,i(!0))},a.onerror=()=>r("onerror"),a.play().then(()=>console.log(`[AudioManager] playing: ${t}`)).catch(()=>{r("catch")})})}async playSequence(e,t){this.interrupted=!1;for(const i of t){this.waitingForAudios++;const a=await this.playFile(e,i);if(this.waitingForAudios--,this.interrupted)return!0;if(!a)return!1}return!0}stopAll(){return this.currentAudio&&(this.interrupted=!0,this.currentAudio.pause(),this.currentAudio.onended?.(new Event("ended"))),this.currentAudio=null,this.waitingForAudios>0}}var _=(l=>(l.EASY="easy",l.MEDIUM="medium",l.HARD="hard",l))(_||{});const w={GHOST_START_PROBABILITY:{[_.EASY]:.1,[_.MEDIUM]:.15,[_.HARD]:.2},GHOST_PROBABILITY_INCREMENT:{[_.EASY]:.05,[_.MEDIUM]:.05,[_.HARD]:.05},SWITCH_VIEW_CLICKS:10,MAGIC_DOOR_MAX_COUNT_BY_DIFFICULTY:{[_.EASY]:1,[_.MEDIUM]:2,[_.HARD]:3},SUNSET_PERCENTAGE:.5,EVENING_PERCENTAGE:.7,CLOSE_TO_MIDNIGHT_PERCENTAGE:.9,MOVES_UNTIL_MIDNIGHT:{[_.EASY]:100,[_.MEDIUM]:70,[_.HARD]:50},ALLOW_GAME_OVER:{[_.EASY]:!1,[_.MEDIUM]:!1,[_.HARD]:!0},LONG_PRESS_DURATION:3e3,AVERAGE_WPM:250,MESSAGE_BUFFER_SECONDS:1.5};class H{ghostCreature;difficulty;constructor(e,t){this.ghostCreature=e,this.difficulty=t}getGhostCreatureHint(){return this.difficulty===_.EASY?this._getFullGhostCreature():this._getPartialGhostCreature()}_getFullGhostCreature(){return`${this.ghostCreature.color}_${this.ghostCreature.type}`}_getPartialGhostCreature(){return`${this.ghostCreature.type}`}}class W{creature1;creature2;difficulty;constructor(e,t,i){this.creature1=e,this.creature2=t,this.difficulty=i}getCreature1Hint(){return this.difficulty===_.EASY?this._getFullCreature1():this._getPartialCreature1()}getCreature2Hint(){return this.difficulty===_.EASY?this._getFullCreature2():this._getPartialCreature2()}_getFullCreature1(){return`${this.creature1.color}_${this.creature1.type}`}_getPartialCreature1(){return`${this.creature1.type}`}_getFullCreature2(){return`${this.creature2.color}_${this.creature2.type}`}_getPartialCreature2(){return`${this.creature2.type}`}}class F{audioManager;messages;language;_waitingForMessage;_recordingTurn;_lastTurnHistory;_currentTurnHistory;_messagePromise;_resolveInterruption;_messageTimeout;_interrupted;constructor(e,t,i){this.audioManager=e,this.messages=t,this.language=i,this._waitingForMessage=0,this._recordingTurn=!1,this._lastTurnHistory=[],this._currentTurnHistory=[],this._messagePromise=null,this._resolveInterruption=null,this._messageTimeout=null,this._interrupted=!1}async intro(){await this._playSequence("music",["intro.m4a"]),await this._playSequence("hubi",["game_intro.m4a"],"game_intro"),await this._playSequence("host",["game_intro_2.m4a"],"game_intro_2"),await this.selectPlayers()}async selectPlayers(){await this._playSequence("host",["players_selection_intro.m4a"],"player_selection_intro")}async addPlayer(e){await this._playSequence("host",["player_selected_pre.m4a",this._playerName(e),"player_selected_post.m4a"],"player_selected",[e.name])}async playerAlreadyInGame(e){await this._playSequence("host",[this._playerName(e),"player_already_in_game.m4a"],"player_already_in_game",[e.name])}async bothRabbitAndMouseRequired(){await this._playSequence("host",["both_rabbit_and_mouse_required.m4a"],"both_rabbit_and_mouse_required")}async selectFirstPlayer(){await this._playSequence("host",["select_first_player.m4a"],"select_first_player")}async firstPlayerSelected(e){await this._playSequence("host",[this._playerName(e),"first_player_selected.m4a"],"first_player_selected",[e.name])}async firstPlayerNotSelected(){await this._playSequence("host",["first_player_not_selected.m4a"],"first_player_not_selected")}async firstPlayerMustBeInGame(){await this._playSequence("host",["first_player_must_be_in_game.m4a"],"first_player_must_be_in_game")}async gameStart(){await this._playSequence("music",["game_start.m4a"])}async askWhereTo(e,t){await this._playSequence("sfx",[`${e.type}.m4a`]),await this._playSequence(e.type,[this._playerName(t),"ask_where_to.m4a"],"ask_where_to",[t.name])}async invalidMove(){await this._playSequence("host",["invalid_move.m4a"],"invalid_move")}async magicDoorOpened(e,t){await this._playSequence("sfx",["open_door.m4a"]),await this._playSequence(e.type,["magic_door_opened.m4a"],"magic_door_opened"),t&&await this._playSequence("hubi",["hubi_awake.m4a"],"hubi_awake")}async announceWall(e,t){let i=`${t.type}`;t.isExternal?i="external_wall":t.isOpen&&(i=`opened_${t.type}`),await this._playSequence(e.type,[`${i}.m4a`],i,[])}async canPassThrough(e){await this._playSequence(e.type,["can_pass_through.m4a"],"can_pass_through",[])}async cannotPassThrough(e){await this._playSequence(e.type,["cannot_pass_through.m4a"],"cannot_pass_through",[])}async giveHint(e,t){t instanceof H?await this._playSequence(e.type,["ghost_hint.m4a",`${t.getGhostCreatureHint()}.m4a`],"ghost_hint",[t.getGhostCreatureHint()]):t instanceof W&&await this._playSequence(e.type,["door_hint.m4a",`${t.getCreature1Hint()}.m4a`,"and.m4a",`${t.getCreature2Hint()}.m4a`],"door_hint",[t.getCreature1Hint(),t.getCreature2Hint()])}async givePlayerPosition(e,t,i,a){await this._playSequence("host",[this._playerName(e),"player_position.m4a",`${t.color}_${t.type}.m4a`,"closer_to.m4a",`${i.color}_${i.type}.m4a`,"cell.m4a",`${a}.m4a`],"player_position",[e.name,`${t.color}_${t.type}`,`${i.color}_${i.type}`,a])}async ghostMoved(){await this._playSequence("sfx",["ghost.m4a"]),await this._playSequence("hubi",["hubi_moved.m4a"],"hubi_moved"),await this._playSequence("host",["ghost_moved.m4a"],"ghost_moved")}async hubiFoundByOnePlayer(){await this._playSequence("hubi",["hubi_found_by_one_player.m4a"],"hubi_found_by_one_player")}async hubiFoundByTwoPlayers(){await this._playSequence("hubi",["hubi_found_by_two_players.m4a"],"hubi_found_by_two_players")}async bonusMove(e){await this._playSequence(e.type,["bonus_move.m4a"],"bonus_move")}async itsPlayerTurn(e){await this._playSequence("host",[this._playerName(e),"its_player_turn.m4a"],"its_player_turn",[e.name])}async sunset(){await this._playSequence("host",["sunset.m4a"],"sunset")}async evening(){await this._playSequence("host",["evening.m4a"],"evening")}async closeToMidnight(){await this._playSequence("host",["close_to_midnight.m4a"],"close_to_midnight")}async midnight(){await this._playSequence("host",["midnight.m4a"],"midnight")}async gameWon(){await this.hubiFoundByTwoPlayers(),await this._playSequence("music",["game_win_1.m4a"]),await this._playSequence("host",["game_won.m4a"],"game_won"),await this._playSequence("music",["game_win_2.m4a"])}async gameOver(){await this._playSequence("music",["game_over.m4a"]),await this._playSequence("host",["game_over.m4a"],"game_over")}async _playSequence(e,t,i=null,a=[]){this._recordingTurn&&this._currentTurnHistory.push({source:e,filesSequence:t,labelId:i,args:a}),this._messagePromise&&(this._waitingForMessage++,await this._messagePromise,this._waitingForMessage--),this._interrupted=!1,!await this.audioManager.playSequence(e,t)&&i&&await this._displayMessage(e,i,a)}startRecordingTurn(){this._recordingTurn=!0,this._currentTurnHistory=[]}stopRecordingTurn(){this._recordingTurn=!1,this._lastTurnHistory=this._currentTurnHistory}async replayLastTurn(){const e=this._recordingTurn;this._recordingTurn=!1;for(const t of this._lastTurnHistory)await this._playSequence(t.source,t.filesSequence,t.labelId,t.args);this._recordingTurn=e}async _displayMessage(e,t,i){const a=document.getElementById("narrator-message-container");if(!a)return;let s=this._getMessage(t,i),r=e?this.messages[this.language][e]||this._capitalize(e):"";a.innerHTML=`
            ${r?`<span class="source">${r}:</span>`:""}
            <span class="text">${s}</span>
        `,a.classList.add("active"),this._messagePromise=new Promise(o=>{const n=h=>{a.classList.remove("active"),this._messagePromise=null,this._resolveInterruption=null,h()};this._resolveInterruption=()=>n(o),this._messageTimeout&&clearTimeout(this._messageTimeout);const d=(s.split(/\s+/).length/w.AVERAGE_WPM*60+w.MESSAGE_BUFFER_SECONDS)*1e3;this._messageTimeout=setTimeout(()=>n(o),d)})}interrupt(){let e=!1,t=0;this.audioManager.stopAll()&&(e=!0,t=this.audioManager.waitingForAudios);const i=document.getElementById("narrator-message-container");return i&&i.classList.remove("active"),this._messageTimeout&&(clearTimeout(this._messageTimeout),this._messageTimeout=null),(this._messagePromise||this._resolveInterruption)&&(e=!0),this._resolveInterruption&&(this._resolveInterruption(),this._resolveInterruption=null),this._messagePromise=null,e&&(this._waitingForMessage>0||t>0)}_getMessage(e,t=[]){let i=this.messages[this.language][e]||e;return t.forEach((a,s)=>{i=i.replace(`{${s}}`,this.messages[this.language][a]||a)}),i}_playerName(e){return`${e.color}_${e.type}.m4a`}_capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}}var C=(l=>(l.Owl="owl",l.Millipede="millipede",l.Bat="bat",l.Frog="frog",l))(C||{}),k=(l=>(l.White="white",l.Black="black",l))(k||{});class R{row;col;type;color;flipped;constructor(e,t,i,a,s){this.row=e,this.col=t,this.type=i,this.color=a,this.flipped=s}}var p=(l=>(l.NO_WALL="no_wall",l.MOUSE_HOLE="mouse_hole",l.RABBIT_WINDOW="rabbit_window",l.WALL="wall",l.FREE_PASSAGE="free_passage",l.MAGIC_DOOR="magic_door",l))(p||{}),P=(l=>(l.HORIZONTAL="horizontal",l.VERTICAL="vertical",l))(P||{});class O{row;col;type;isOpen;isExternal;orientation;isRevealed;constructor(e,t,i,a){this.row=e,this.col=t,this.type="no_wall",this.isOpen=!1,this.isExternal=i,this.orientation=a,this.isRevealed=this.isExternal}cycleState(){if(!this.isExternal)switch(this.type){case"no_wall":this.type="mouse_hole";break;case"mouse_hole":this.type="rabbit_window";break;case"rabbit_window":this.type="wall";break;case"wall":this.type="free_passage";break;case"free_passage":this.type="magic_door";break;case"magic_door":this.type="no_wall",this.isOpen=!1;break}}toggleOpen(){this.isExternal||this.type==="magic_door"&&(this.isOpen=!this.isOpen)}open(){this.isOpen=!0}reveal(){this.isRevealed=!0}}class ${static generate(e,t){let i=!1,a=0;const s=1e4;let r=1;for(t===_.MEDIUM&&(r=2),t===_.HARD&&(r=3);!i&&a<s;){a++,this.resetWalls(e);const o=this.getAllInternalEdges();this.shuffle(o);const n=this.buildSpanningTree(o);let u=[],m=new Set;for(let c=0;c<n.length;c++){const v=[...n];v.splice(c,1);const E=this.getComponent(v,0),A=E.has(0)&&E.has(12),V=E.has(3)||E.has(15);if(A&&!V){u.push(n[c]),m=E;break}}if(u.length===0)continue;const d=[];for(const c of o){if(c===u[0])continue;const v=c.r1*4+c.c1,E=c.r2*4+c.c2;m.has(v)!==m.has(E)&&d.push(c)}let h={W:2,R:4,M:4,F:14-r,D:r};const y=new Map;if(y.set(u[0],"D"),h.D--,d.length<h.D)continue;for(this.shuffle(d);h.D>0;h.D--){const c=d.shift();c&&(y.set(c,"D"),u.push(c))}for(const c of d)h.W>0&&(y.set(c,"W"),h.W--);const L=o.filter(c=>!y.has(c));L.sort((c,v)=>{const E=n.includes(c);return(n.includes(v)?1:0)-(E?1:0)});for(const c of L)d.includes(c)?h.M>0&&h.R>0?Math.random()<.5?(y.set(c,"M"),h.M--):(y.set(c,"R"),h.R--):h.M>0?(y.set(c,"M"),h.M--):h.R>0?(y.set(c,"R"),h.R--):h.F>0&&(y.set(c,"F"),h.F--):n.includes(c)?h.F>0?(y.set(c,"F"),h.F--):h.R>0?(y.set(c,"R"),h.R--):h.M>0?(y.set(c,"M"),h.M--):h.W>0&&(y.set(c,"W"),h.W--):h.W>0?(y.set(c,"W"),h.W--):h.M>0?(y.set(c,"M"),h.M--):h.R>0?(y.set(c,"R"),h.R--):h.F>0&&(y.set(c,"F"),h.F--);if(this.checkConnectivity(y,"rabbit")&&this.checkConnectivity(y,"mouse")){e.magicDoors=[];for(const[c,v]of y){const E=e.getWallBetween(c.r1,c.c1,c.r2,c.c2);this.applyTypeToWall(E,v),E.type===p.MAGIC_DOOR&&e.magicDoors.push(E)}i=!0,console.log(`Generated valid board in ${a} attempts with ${r} magic doors.`)}}i||console.error("Could not generate valid board.")}static resetWalls(e){for(const t of e.horizontalWalls)for(const i of t)i.isExternal||(i.type=p.WALL);for(const t of e.verticalWalls)for(const i of t)i.isExternal||(i.type=p.WALL)}static getAllInternalEdges(){const e=[];for(let t=0;t<4;t++)for(let i=0;i<3;i++)e.push({r1:t,c1:i,r2:t,c2:i+1});for(let t=0;t<3;t++)for(let i=0;i<4;i++)e.push({r1:t,c1:i,r2:t+1,c2:i});return e}static shuffle(e){for(let t=e.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}}static buildSpanningTree(e){const t=[],i=new Array(16).fill(0).map((r,o)=>o),a=r=>i[r]===r?r:(i[r]=a(i[r]),i[r]),s=(r,o)=>{const n=a(r),u=a(o);return n!==u?(i[n]=u,!0):!1};for(const r of e){const o=r.r1*4+r.c1,n=r.r2*4+r.c2;s(o,n)&&t.push(r)}return t}static getComponent(e,t){const i=Array.from({length:16},()=>[]);for(const r of e){const o=r.r1*4+r.c1,n=r.r2*4+r.c2;i[o].push(n),i[n].push(o)}const a=new Set,s=[t];for(a.add(t);s.length;){const r=s.shift();if(r!==void 0&&i[r])for(const o of i[r])a.has(o)||(a.add(o),s.push(o))}return a}static checkConnectivity(e,t){const i=Array.from({length:16},()=>[]);for(const[r,o]of e){let n=!1;if(o==="F"&&(n=!0),o==="D"&&(n=!0),t==="rabbit"&&o==="R"&&(n=!0),t==="mouse"&&o==="M"&&(n=!0),n){const u=r.r1*4+r.c1,m=r.r2*4+r.c2;i[u].push(m),i[m].push(u)}}const a=new Set,s=[0];for(a.add(0);s.length;){const r=s.shift();if(r!==void 0)for(const o of i[r])a.has(o)||(a.add(o),s.push(o))}return a.size===16}static applyTypeToWall(e,t){switch(t){case"W":e.type=p.WALL;break;case"R":e.type=p.RABBIT_WINDOW;break;case"M":e.type=p.MOUSE_HOLE;break;case"F":e.type=p.FREE_PASSAGE;break;case"D":e.type=p.MAGIC_DOOR,e.isOpen=!1;break}}static getWallChar(e,t){let i=" ";switch(e.type){case p.WALL:i="W";break;case p.RABBIT_WINDOW:i="R";break;case p.MOUSE_HOLE:i="M";break;case p.MAGIC_DOOR:i="D";break;case p.FREE_PASSAGE:i="F";break}return t?`- ${i} -`:i}}class Y{tiles;horizontalWalls;verticalWalls;magicDoors;constructor(e){this.tiles=[],this.horizontalWalls=[],this.verticalWalls=[],this.magicDoors=[],this.initialize(e)}initialize(e){const t=[[C.Owl,C.Millipede,C.Frog,C.Owl],[C.Frog,C.Bat,C.Bat,C.Millipede]];for(let i=0;i<4;i++){let a=[];for(let s=0;s<4;s++){const r=i%2===s%2?k.White:k.Black;i<2?a.push(new R(i,s,t[i][s],r,!1)):a.push(new R(i,s,t[4-i-1][4-s-1],r,!0))}this.tiles.push(a)}for(let i=0;i<5;i++){let a=[],s=[];for(let r=0;r<5;r++)r<5&&a.push(new O(i,r,i==0||i==4,P.HORIZONTAL)),s.push(new O(i,r,r==0||r==4,P.VERTICAL));this.horizontalWalls.push(a),i<5&&this.verticalWalls.push(s)}$.generate(this,e)}getWallBetween(e,t,i,a){if(e==i)return this.verticalWalls[e][Math.max(t,a)];if(t==a)return this.horizontalWalls[Math.max(e,i)][t];throw new Error(`Invalid wall coordinates: ${e},${t} to ${i},${a}`)}getTilesOnBothSides(e){return e.orientation===P.HORIZONTAL?[this.tiles[e.row-1][e.col],this.tiles[e.row][e.col]]:[this.tiles[e.row][e.col-1],this.tiles[e.row][e.col]]}getCell(e,t){return this.tiles[e][t]}getCreature(e){return this.tiles[e.row][e.col]}}var S=(l=>(l.RABBIT="rabbit",l.MOUSE="mouse",l))(S||{});class g{static BLUE_RABBIT=new g("blue","rabbit");static GREEN_RABBIT=new g("green","rabbit");static YELLOW_MOUSE=new g("yellow","mouse");static RED_MOUSE=new g("red","mouse");color;type;name;row;col;constructor(e,t){this.color=e,this.type=t,this.name=`${e}_${t}`,this.row=-1,this.col=-1,this.setInitialPosition()}setInitialPosition(){switch(this.color){case"green":this.row=0,this.col=0;break;case"red":this.row=0,this.col=3;break;case"blue":this.row=3,this.col=0;break;case"yellow":this.row=3,this.col=3;break}}capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}}const b={NO_STATE:"NO_STATE",SELECTING_PLAYERS:"SELECTING_PLAYERS",SELECTING_FIRST_PLAYER:"SELECTING_FIRST_PLAYER",PLAYING_BEFORE_DOOR:"PLAYING_BEFORE_DOOR",PLAYING_WITH_HUBI:"PLAYING_WITH_HUBI",WON:"WON",GAME_OVER:"GAME_OVER"};class q{game;narrator;currentState;requiredMagicDoorCount;openedMagicDoorCount;constructor(e,t,i){this.game=e,this.narrator=t,this.currentState=b.NO_STATE,this.requiredMagicDoorCount=this._computeRequiredMagicDoorCount(i),this.openedMagicDoorCount=0}async init(){this.currentState=b.SELECTING_PLAYERS,await this.narrator.intro()}async selectFirstPlayer(){return this.currentState===b.SELECTING_PLAYERS&&await this._validatePlayers()?(this.currentState=b.SELECTING_FIRST_PLAYER,await this.narrator.selectFirstPlayer(),!0):!1}async startGame(){return this.currentState===b.SELECTING_FIRST_PLAYER&&await this._validateFirstPlayer()?(this.currentState=b.PLAYING_BEFORE_DOOR,await this.narrator.gameStart(),await this.game.startTurn(),!0):!1}async tryOpenDoor(e){const t=this.game.board.getTilesOnBothSides(e);if(this.game.getPlayersAt(t[0].row,t[0].col).length>=1&&this.game.getPlayersAt(t[1].row,t[1].col).length>=1){e.open(),this.openedMagicDoorCount++;const i=this.isHubiAwake();return!this.isHubiAwake()&&this.openedMagicDoorCount>=this.requiredMagicDoorCount&&(this.currentState=b.PLAYING_WITH_HUBI,await this.game.spawnGhost()),this.game.currentPlayer?(await this.narrator.magicDoorOpened(this.game.board.getCreature(this.game.currentPlayer),!i&&this.isHubiAwake()),!0):!1}return!1}async checkWinCondition(){return this.currentState===b.PLAYING_WITH_HUBI&&this.game.getPlayersAt(this.game.ghost.row,this.game.ghost.col).length>=2?(await this.narrator.gameWon(),this.currentState=b.WON,!0):!1}async checkGameOverCondition(){const e=w.MOVES_UNTIL_MIDNIGHT[this.game.difficulty];if(this.game.totalTurns==Math.floor(e*w.SUNSET_PERCENTAGE))await this.narrator.sunset();else if(this.game.totalTurns==Math.floor(e*w.EVENING_PERCENTAGE))await this.narrator.evening();else if(this.game.totalTurns==Math.floor(e*w.CLOSE_TO_MIDNIGHT_PERCENTAGE))await this.narrator.closeToMidnight();else if(this.game.totalTurns==e&&(await this.narrator.midnight(),w.ALLOW_GAME_OVER[this.game.difficulty]))return await this.narrator.gameOver(),this.currentState=b.GAME_OVER,!0;return!1}async _validatePlayers(){const e=this.game.players,t=e.values().filter(a=>a.type===S.RABBIT).toArray(),i=e.values().filter(a=>a.type===S.MOUSE).toArray();return t.length<1||i.length<1?(await this.narrator.bothRabbitAndMouseRequired(),!1):!0}async _validateFirstPlayer(){return this.game.currentPlayer?!0:(await this.narrator.firstPlayerNotSelected(),!1)}is(e){return this.currentState===e}isPlaying(){return this.currentState===b.PLAYING_BEFORE_DOOR||this.currentState===b.PLAYING_WITH_HUBI}isHubiAwake(){return this.currentState===b.PLAYING_WITH_HUBI}isOver(){return this.currentState===b.WON||this.currentState===b.GAME_OVER}_computeRequiredMagicDoorCount(e){return w.MAGIC_DOOR_MAX_COUNT_BY_DIFFICULTY[e]}}class x{game;narrator;row;col;active;probability;difficulty;constructor(e,t,i){this.game=e,this.narrator=t,this.row=-1,this.col=-1,this.active=!1,this.probability=0,this.difficulty=i}spawn(){if(this.active)return;let e=[];for(let t=0;t<4;t++)for(let i=0;i<4;i++)this.game.getPlayersAt(t,i).length===0&&e.push({r:t,c:i});if(e.length>0){const t=e[Math.floor(Math.random()*e.length)];this.row=t.r,this.col=t.c,this.active=!0,this.probability=w.GHOST_START_PROBABILITY[this.difficulty],console.log(`Ghost spawned at ${this.row}, ${this.col}`)}}async maybeMove(){if(!this.active)return!1;if(Math.random()>this.probability)return this.probability=Math.min(1,this.probability+w.GHOST_PROBABILITY_INCREMENT[this.difficulty]),console.log(`Ghost did not move. Probability increased to ${this.probability.toFixed(2)}`),!1;this.probability=w.GHOST_START_PROBABILITY[this.difficulty];const e=[{dr:-1,dc:-1},{dr:-1,dc:0},{dr:-1,dc:1},{dr:0,dc:-1},{dr:0,dc:1},{dr:1,dc:-1},{dr:1,dc:0},{dr:1,dc:1}],t=[];for(const i of e){const a=this.row+i.dr,s=this.col+i.dc;a>=0&&a<4&&s>=0&&s<4&&this.game.getPlayersAt(a,s).length===0&&t.push({r:a,c:s})}if(t.length>0){const i=t[Math.floor(Math.random()*t.length)];return this.row=i.r,this.col=i.c,console.log(`Ghost moved to ${this.row}, ${this.col}`),await this.narrator.ghostMoved(),!0}else return console.log("Ghost stuck! No valid moves."),!1}}class U{difficulty;board;gameState;narrator;players;ghost;currentPlayer;previousPlayer;movesMade;totalTurns;givenHints;constructor(e,t){this.difficulty=e,this.board=new Y(e),this.gameState=new q(this,t,e),this.narrator=t,this.players=new Set,this.ghost=new x(this,t,e),this.currentPlayer=g.GREEN_RABBIT,this.previousPlayer=null,this.movesMade=0,this.totalTurns=0,this.givenHints=new Map}addPlayer(e){return this.hasPlayer(e)?(this.narrator.playerAlreadyInGame(e),!1):(this.players.add(e),this.narrator.addPlayer(e),!0)}hasPlayer(e){return this.players.has(e)}getPlayersAt(e,t){return Array.from(this.players.values()).filter(i=>i.row===e&&i.col===t)}async setFirstPlayer(e){return this.hasPlayer(e)?(this.previousPlayer=this.currentPlayer,this.currentPlayer=e,await this.narrator.firstPlayerSelected(e),!0):(await this.narrator.firstPlayerMustBeInGame(),!1)}spawnGhost(){this.ghost.spawn()}async moveToNextPlayer(){this.currentPlayer==g.GREEN_RABBIT?this.currentPlayer=g.RED_MOUSE:this.currentPlayer==g.RED_MOUSE?this.currentPlayer=g.YELLOW_MOUSE:this.currentPlayer==g.YELLOW_MOUSE?this.currentPlayer=g.BLUE_RABBIT:this.currentPlayer==g.BLUE_RABBIT&&(this.currentPlayer=g.GREEN_RABBIT),this.currentPlayer&&this.hasPlayer(this.currentPlayer)?await this.startTurn():await this.moveToNextPlayer()}async moveCurrentPlayer(e){const t=this.currentPlayer,i=this.board.getCreature(t),a=e.dRow(),s=e.dCol(),r=t.row+a,o=t.col+s;if(!(Math.abs(a)===1&&Math.abs(s)===0||Math.abs(a)===0&&Math.abs(s)===1)){console.error(`Invalid move: ${e}`),await this.narrator.invalidMove();return}const n=this.board.getWallBetween(t.row,t.col,r,o);if(!n)return;await this.narrator.announceWall(i,n);const u=n.isRevealed;n.reveal();let m=this.ghost.active;n.type===p.MAGIC_DOOR&&!n.isOpen&&await this.gameState.tryOpenDoor(n)&&(this.givenHints=new Map);let d=this.canPass(n,t);if(d){if(await this.narrator.canPassThrough(i),t.row=r,t.col=o,await this.gameState.checkWinCondition())return}else await this.narrator.cannotPassThrough(i);if(d&&this.ghost.active&&t.row===this.ghost.row&&t.col===this.ghost.col?await this.narrator.hubiFoundByOnePlayer():m&&await this.ghost.maybeMove()&&(this.givenHints=new Map),u&&(this.movesMade++,this.movesMade===1)){await this.narrator.bonusMove(i);return}this.totalTurns++,!await this.gameState.checkGameOverCondition()&&await this.endTurn()}canPass(e,t){return e.isExternal?!1:e.type===p.NO_WALL?(console.error("Missing wall!"),!1):e.type===p.WALL?!1:!!(e.type===p.FREE_PASSAGE||e.type===p.MOUSE_HOLE&&t.type===S.MOUSE||e.type===p.RABBIT_WINDOW&&t.type===S.RABBIT||e.type===p.MAGIC_DOOR&&e.isOpen)}generateHint(){if(this.gameState.isHubiAwake()){const e=this.board.getCreature(this.ghost);return new H(e,this.difficulty)}else{let e=null;for(let t=0;t<this.board.magicDoors.length;t++){const i=this.board.magicDoors[t];if(!i.isOpen){e=i;break}}if(e){const t=this.board.getTilesOnBothSides(e);return new W(t[0],t[1],this.difficulty)}}throw new Error("Failed to generate hint.")}async giveHint(){const e=this.board.getCreature(this.currentPlayer);let t=this.givenHints.get(e);t||(t=this.generateHint(),this.givenHints.set(e,t)),await this.narrator.giveHint(e,t),this.totalTurns++,!await this.gameState.checkGameOverCondition()&&await this.endTurn()}async givePlayerPosition(e){const t=this.board.getCreature(e);let i=this.board.getCell(0,0),a="green";e.row<2&&e.col<2?(i=this.board.getCell(0,0),a="green"):e.row<2&&e.col>=2?(i=this.board.getCell(0,3),a="red"):e.row>=2&&e.col<2?(i=this.board.getCell(3,0),a="blue"):e.row>=2&&e.col>=2&&(i=this.board.getCell(3,3),a="yellow"),console.log(a),await this.narrator.givePlayerPosition(e,t,i,a)}async startTurn(){await this.narrator.startRecordingTurn(),await this.narrator.askWhereTo(this.board.getCreature(this.currentPlayer),this.currentPlayer)}async endTurn(){this.movesMade=0,await this.narrator.stopRecordingTurn(),this.previousPlayer=this.currentPlayer,await this.moveToNextPlayer()}isOver(){return this.gameState.isOver()}}class z{container;compassElements;navClickCount;onHelpClick;onHelpLongPress;onBlueRabbitClick;onYellowMouseClick;onGreenRabbitClick;onRedMouseClick;onNorthClick;onEastClick;onSouthClick;onWestClick;switchToBoard;constructor(e){this.container=document.getElementById(e),this.compassElements=new Map,this.navClickCount=0}render(){this.container.innerHTML="";const e=document.createElement("div");e.className="magic-compass-wrapper";const t=document.createElement("div");t.className="magic-compass";const i=document.createElement("img");i.src="images/magic-compass.jpg",i.alt="Magic Compass",i.className="compass-bg",t.appendChild(i),[{id:"blue-rabbit-btn",type:"animal-btn",label:"Blue Rabbit"},{id:"yellow-mouse-btn",type:"animal-btn",label:"Yellow Mouse"},{id:"green-rabbit-btn",type:"animal-btn",label:"Green Rabbit"},{id:"red-mouse-btn",type:"animal-btn",label:"Red Mouse"},{id:"north-btn",type:"cardinal-btn",label:"Ocean"},{id:"east-btn",type:"cardinal-btn",label:"Forest"},{id:"south-btn",type:"cardinal-btn",label:"Mountains"},{id:"west-btn",type:"cardinal-btn",label:"City"},{id:"help-btn",type:"help-btn",label:"?"}].forEach(o=>{const n=document.createElement("div");n.className=`compass-btn ${o.type} ${o.id}`,n.title=o.label,o.id==="help-btn"?this.setupLongPressHandler(n,()=>{o.id==="help-btn"&&this.onHelpClick&&this.onHelpClick()},()=>{o.id==="help-btn"&&this.onHelpLongPress&&this.onHelpLongPress()}):n.onclick=()=>{o.id==="blue-rabbit-btn"&&this.onBlueRabbitClick&&this.onBlueRabbitClick(),o.id==="yellow-mouse-btn"&&this.onYellowMouseClick&&this.onYellowMouseClick(),o.id==="green-rabbit-btn"&&this.onGreenRabbitClick&&this.onGreenRabbitClick(),o.id==="red-mouse-btn"&&this.onRedMouseClick&&this.onRedMouseClick(),o.id==="north-btn"&&this.onNorthClick&&this.onNorthClick(),o.id==="east-btn"&&this.onEastClick&&this.onEastClick(),o.id==="south-btn"&&this.onSouthClick&&this.onSouthClick(),o.id==="west-btn"&&this.onWestClick&&this.onWestClick(),o.id==="help-btn"&&this.onHelpClick&&this.onHelpClick()},t.appendChild(n)}),e.appendChild(t),[{id:"light-blue-rabbit",class:"light-bottom-left"},{id:"light-yellow-mouse",class:"light-bottom-right"},{id:"light-green-rabbit",class:"light-top-left"},{id:"light-red-mouse",class:"light-top-right"}].forEach(o=>{const n=document.createElement("div");n.className=`compass-light ${o.class}`,n.id=o.id,t.appendChild(n)});const r=document.createElement("div");r.className="invisible-nav-btn",r.onclick=()=>{this.navClickCount++,this.navClickCount>=w.SWITCH_VIEW_CLICKS&&(this.navClickCount=0,this.switchToBoard&&this.switchToBoard())},e.appendChild(r),this.container.appendChild(e)}show(){this.container.classList.remove("hidden")}hide(){this.container.classList.add("hidden")}bindHelpButtonClick(e){this.onHelpClick=e}bindHelpButtonLongPress(e){this.onHelpLongPress=e}bindBlueRabbitButtonClick(e){this.onBlueRabbitClick=e}bindYellowMouseButtonClick(e){this.onYellowMouseClick=e}bindGreenRabbitButtonClick(e){this.onGreenRabbitClick=e}bindRedMouseButtonClick(e){this.onRedMouseClick=e}bindNorthButtonClick(e){this.onNorthClick=e}bindEastButtonClick(e){this.onEastClick=e}bindSouthButtonClick(e){this.onSouthClick=e}bindWestButtonClick(e){this.onWestClick=e}bindSwitchToBoard(e){this.switchToBoard=e}togglePlayerLightsOff(){this._toggleBlueRabbitLight(!1),this._toggleYellowMouseLight(!1),this._toggleGreenRabbitLight(!1),this._toggleRedMouseLight(!1)}togglePlayerLightOn(e){this._togglePlayerLight(e,!0)}togglePlayerLightOff(e){this._togglePlayerLight(e,!1)}_togglePlayerLight(e,t){e===g.BLUE_RABBIT?this._toggleBlueRabbitLight(t):e===g.YELLOW_MOUSE?this._toggleYellowMouseLight(t):e===g.GREEN_RABBIT?this._toggleGreenRabbitLight(t):e===g.RED_MOUSE?this._toggleRedMouseLight(t):console.error(`Unknown playerInfo: ${e}`)}_toggleBlueRabbitLight(e){this._togglePlayerLightById("light-blue-rabbit",e)}_toggleYellowMouseLight(e){this._togglePlayerLightById("light-yellow-mouse",e)}_toggleGreenRabbitLight(e){this._togglePlayerLightById("light-green-rabbit",e)}_toggleRedMouseLight(e){this._togglePlayerLightById("light-red-mouse",e)}_togglePlayerLightById(e,t){const i=document.getElementById(e);i&&(t?i.classList.add("on"):i.classList.remove("on"))}setupLongPressHandler(e,t,i){let a,s=!1;const r=w.LONG_PRESS_DURATION,o=m=>{m.type==="click"&&m.button!==0||(s=!1,a=setTimeout(()=>{s=!0,navigator.vibrate&&navigator.vibrate(50),i()},r))},n=()=>{clearTimeout(a)},u=m=>{s?(m.preventDefault(),m.stopPropagation()):t()};e.addEventListener("mousedown",o),e.addEventListener("touchstart",o,{passive:!0}),e.addEventListener("mouseup",n),e.addEventListener("mouseleave",n),e.addEventListener("touchend",n),e.addEventListener("click",u)}}class j{container;onStart;constructor(e){this.container=document.getElementById(e),this.onStart=null}bindStartGame(e){this.onStart=e}render(){this.container.innerHTML=`
            <div class="selection-screen">
                <h2>Select Players</h2>
                <p>Must have at least 1 Rabbit and 1 Mouse.</p>
                <div class="player-options">
                    <div class="option-row">
                        <label class="option blue">
                            <input type="checkbox" value="blue-rabbit" data-id="blue-rabbit"> Blue Rabbit üê∞
                        </label>
                        <label class="first-select"><input type="radio" name="first-player" value="blue-rabbit"> 1st</label>
                    </div>
                    
                    <div class="option-row">
                        <label class="option green">
                            <input type="checkbox" value="green-rabbit" data-id="green-rabbit"> Green Rabbit üê∞
                        </label>
                        <label class="first-select"><input type="radio" name="first-player" value="green-rabbit"> 1st</label>
                    </div>
                    
                    <div class="option-row">
                        <label class="option yellow">
                            <input type="checkbox" value="yellow-mouse" data-id="yellow-mouse"> Yellow Mouse üê≠
                        </label>
                        <label class="first-select"><input type="radio" name="first-player" value="yellow-mouse"> 1st</label>
                    </div>
                    
                    <div class="option-row">
                        <label class="option red">
                            <input type="checkbox" value="red-mouse" data-id="red-mouse"> Red Mouse üê≠
                        </label>
                        <label class="first-select"><input type="radio" name="first-player" value="red-mouse"> 1st</label>
                    </div>
                </div>
                <div id="selection-error" class="error"></div>
                <button id="start-btn">Start Game</button>
            </div>
        `,document.getElementById("start-btn").addEventListener("click",async()=>await this.handleStart())}async handleStart(){const t=Array.from(this.container.querySelectorAll('input[type="checkbox"]:checked')).map(s=>this.idToPlayer(s.dataset.id)).filter(s=>s!==null),i=this.container.querySelector('input[name="first-player"]:checked');let a=i?this.idToPlayer(i.value):null;this.onStart&&await this.onStart({players:t,firstPlayer:a})}idToPlayer(e){if(e==="blue-rabbit")return g.BLUE_RABBIT;if(e==="green-rabbit")return g.GREEN_RABBIT;if(e==="yellow-mouse")return g.YELLOW_MOUSE;if(e==="red-mouse")return g.RED_MOUSE;throw new Error(`Unknown player id: ${e}`)}showError(e){const t=document.getElementById("selection-error");t&&(t.textContent=e,t.classList.add("visible"))}hide(){this.container.style.display="none"}show(){this.container.style.display="block"}}class K{container;wallElements;navClickCount;messageBox;debugViewAll=!1;debugEditMode=!1;onToggleDebugView;onToggleEditMode;onNavigateToCompass;onGoBack;onEndTurn;constructor(e){this.container=document.getElementById(e),this.wallElements=new Map,this.navClickCount=0}render(e,t){this.container.innerHTML="",this.wallElements.clear(),this.messageBox=document.createElement("div"),this.messageBox.className="message-box",this.container.appendChild(this.messageBox),this.createDebugPanel();const i=document.createElement("div");i.className="board",this.debugEditMode&&i.classList.add("edit-mode"),this.container.appendChild(i);const a=document.createElement("div");a.className="invisible-nav-btn",a.onclick=()=>{this.navClickCount++,this.navClickCount>=w.SWITCH_VIEW_CLICKS&&(this.navClickCount=0,this.onNavigateToCompass&&this.onNavigateToCompass())},this.container.appendChild(a);const s=document.createElement("button");s.className="go-back-btn",s.textContent="Go Back",s.onclick=()=>this.onGoBack&&this.onGoBack(),this.container.appendChild(s);for(let r=0;r<9;r++)for(let o=0;o<9;o++){const n=r%2===0,u=o%2===0;if(n&&u){const m=document.createElement("div");m.className="corner",i.appendChild(m)}else if(n)this.createWallElement(e.board.horizontalWalls[r/2][Math.floor(o/2)],t,i);else if(u)this.createWallElement(e.board.verticalWalls[Math.floor(r/2)][o/2],t,i);else{const m=Math.floor(r/2),d=Math.floor(o/2);this.createTileElement(e.board.getCell(m,d),e,t,i)}}e.currentPlayer&&this.updateTurnInfo(e.currentPlayer),this.renderEndTurnButton()}createDebugPanel(){const e=document.createElement("div");e.className="debug-panel";const t=document.createElement("button");t.className=`debug-btn ${this.debugViewAll?"active":""}`,t.innerHTML="üëÅÔ∏è",t.title="Toggle God Mode (View All)",t.onclick=()=>this.onToggleDebugView&&this.onToggleDebugView();const i=document.createElement("button");i.className=`debug-btn ${this.debugEditMode?"active":""}`,i.innerHTML="‚úèÔ∏è",i.title="Toggle Edit Mode",i.onclick=()=>this.onToggleEditMode&&this.onToggleEditMode(),e.appendChild(t),e.appendChild(i),this.container.appendChild(e)}bindToggleDebugView(e){this.onToggleDebugView=e}bindToggleEditMode(e){this.onToggleEditMode=e}bindNavigateToCompass(e){this.onNavigateToCompass=e}bindGoBack(e){this.onGoBack=e}setDebugState(e,t){this.debugViewAll=e,this.debugEditMode=t}showMessage(e){this.messageBox.textContent=e,setTimeout(()=>{this.messageBox.textContent===e&&(this.messageBox.textContent="")},3e3)}createTileElement(e,t,i,a){const s=document.createElement("div");s.className="tile",s.dataset.row=e.row.toString(),s.dataset.col=e.col.toString(),e.flipped&&s.classList.add("flipped");const r=document.createElement("img");if(r.src=`images/${e.color}_${e.type}.png`,s.appendChild(r),t.ghost&&t.ghost.active&&t.ghost.row===e.row&&t.ghost.col===e.col&&this.debugViewAll){const o=document.createElement("div");o.className="ghost-npc",o.textContent="üëª",s.appendChild(o)}if(t.players){const o=Array.from(t.players.values()).filter(u=>u.row===e.row&&u.col===e.col),n=o.length;o.forEach((u,m)=>{const d=document.createElement("div");if(d.className=`player-token ${u.color}`,d.textContent=u.type==="rabbit"?"üê∞":"üê≠",n>1)if(d.classList.add("small"),n===2)m===0?d.classList.add("pos-top-left"):d.classList.add("pos-bottom-right");else switch(u.color){case"green":d.classList.add("pos-top-left");break;case"red":d.classList.add("pos-top-right");break;case"blue":d.classList.add("pos-bottom-left");break;case"yellow":d.classList.add("pos-bottom-right");break}i.selectedPlayer===u&&d.classList.add("selected"),d.addEventListener("click",h=>{h.stopPropagation(),i.handlePlayerClick(u)}),s.appendChild(d)})}s.addEventListener("click",()=>i.handleTileClick(e)),a.appendChild(s)}createWallElement(e,t,i){const a=document.createElement("div");a.className=`wall ${e.type}`,e.isExternal?a.classList.add("external"):(e.isRevealed||this.debugViewAll?(a.dataset.type=e.type,e.isOpen&&a.classList.add("open")):a.classList.add("hidden-wall"),this.debugEditMode&&a.classList.add("editable"),a.addEventListener("click",()=>t.handleWallClick(e)),a.addEventListener("contextmenu",r=>{r.preventDefault(),t.handleWallRightClick(e)})),i.appendChild(a),this.wallElements.set(`${e.orientation},${e.row},${e.col}`,a)}updateWalls(e){e.horizontalWalls.forEach(t=>t.forEach(i=>{this.updateWall(i)})),e.verticalWalls.forEach(t=>t.forEach(i=>{this.updateWall(i)}))}updateWall(e){const t=`${e.orientation},${e.row},${e.col}`,i=this.wallElements.get(t);i&&(e.isRevealed||this.debugViewAll?(i.classList.remove("hidden-wall"),i.dataset.type=e.type,e.isOpen?i.classList.add("open"):i.classList.remove("open")):(i.classList.add("hidden-wall"),i.removeAttribute("data-state"),i.classList.remove("open")))}renderEndTurnButton(){const e=document.createElement("button");e.textContent="End Turn",e.onclick=()=>this.onEndTurn&&this.onEndTurn(),this.container.appendChild(e)}updateTurnInfo(e){let t=document.getElementById("turn-info");t||(t=document.createElement("div"),t.id="turn-info",t.className="turn-info",this.container.appendChild(t)),t.innerHTML=`Current Turn: <span style="color:${e.color}; font-weight:bold; text-transform:capitalize;">${e.color} ${e.type==="rabbit"?"üê∞":"üê≠"}</span>`}bindEndTurn(e){this.onEndTurn=e}show(){this.container.classList.remove("hidden")}hide(){this.container.classList.add("hidden")}}class f{static NORTH=new f("north");static EAST=new f("east");static SOUTH=new f("south");static WEST=new f("west");static getDirection(e,t){if(e===0&&t===0)throw new Error("Invalid direction delta: 0, 0");if(e===0)return t<0?f.WEST:f.EAST;if(t===0)return e<0?f.NORTH:f.SOUTH;throw new Error(`Invalid direction delta: ${e}, ${t}`)}value;constructor(e){this.value=e}dRow(){switch(this){case f.NORTH:return-1;case f.SOUTH:return 1;default:return 0}}dCol(){switch(this){case f.EAST:return 1;case f.WEST:return-1;default:return 0}}}class Z{game;boardView;selectionView;compassView;narrator;selectedPlayer;gameState;debugViewAll;debugEditMode;constructor(e,t,i,a,s){this.game=e,this.boardView=t,this.selectionView=i,this.compassView=a,this.narrator=s,this.selectedPlayer=null,this.gameState=e.gameState,this.debugViewAll=!1,this.debugEditMode=!1}init(){this.selectionView.bindStartGame(async e=>await this.handleSelectionView(e)),this.boardView.bindEndTurn(()=>this.handleEndTurn()),this.compassView.bindSwitchToBoard(()=>this.switchToBoard()),this.boardView.bindGoBack(()=>this.switchToCompass()),this.boardView.bindToggleDebugView(()=>this.toggleDebugView()),this.boardView.bindToggleEditMode(()=>this.toggleEditMode()),this.compassView.bindNorthButtonClick(()=>this._handleNorthClick()),this.compassView.bindEastButtonClick(()=>this._handleEastClick()),this.compassView.bindSouthButtonClick(()=>this._handleSouthClick()),this.compassView.bindWestButtonClick(()=>this._handleWestClick()),this.compassView.bindBlueRabbitButtonClick(()=>this._handleBlueRabbitClick()),this.compassView.bindYellowMouseButtonClick(()=>this._handleYellowMouseClick()),this.compassView.bindGreenRabbitButtonClick(()=>this._handleGreenRabbitClick()),this.compassView.bindRedMouseButtonClick(()=>this._handleRedMouseClick()),this.compassView.bindHelpButtonClick(()=>this._handleHelpClick()),this.compassView.bindHelpButtonLongPress(()=>this._handleHelpLongPress()),this.boardView.render(this.game,this),this.selectionView.render(),this.compassView.render(),this.switchToCompass()}async start(){const e=document.getElementById("start-popup");e&&e.classList.add("hidden"),await this.gameState.init()}async handleEndTurn(){this.compassView.togglePlayerLightOff(this.game.currentPlayer),await this.game.endTurn(),this.selectedPlayer=null,this.boardView.render(this.game,this),this.compassView.togglePlayerLightOn(this.game.currentPlayer)}async handleSelectionView(e){for(const t of e.players)await this.game.addPlayer(t);await this.gameState.selectFirstPlayer(),e.firstPlayer&&await this.game.setFirstPlayer(e.firstPlayer),await this.gameState.startGame(),this.selectionView.hide(),this.boardView.render(this.game,this)}handlePlayerClick(e){if(this.gameState.isPlaying()){if(e!==this.game.currentPlayer){this.narrator.itsPlayerTurn(e);return}this.selectedPlayer=e,this.boardView.render(this.game,this)}}async handleTileClick(e){if(!this.gameState.isPlaying()||!this.selectedPlayer)return;const t=this.game.currentPlayer;let i;try{i=f.getDirection(e.row-t.row,e.col-t.col)}catch(a){console.error(a),this.narrator.invalidMove();return}this.compassView.togglePlayerLightOff(t),await this.game.moveCurrentPlayer(i),this.selectedPlayer=null,this.boardView.render(this.game,this),this.compassView.togglePlayerLightOn(this.game.currentPlayer)}handleWallClick(e){this.selectedPlayer=null,!e.isExternal&&this.debugEditMode&&(e.cycleState(),this.boardView.updateWall(e))}handleWallRightClick(e){this.selectedPlayer=null,!e.isExternal&&this.debugEditMode&&e.type===p.MAGIC_DOOR&&(e.toggleOpen(),this.boardView.updateWall(e))}toggleDebugView(){this.debugViewAll=!this.debugViewAll,this.boardView.setDebugState(this.debugViewAll,this.debugEditMode),this.boardView.render(this.game,this)}toggleEditMode(){this.debugEditMode=!this.debugEditMode,this.debugEditMode&&(this.debugViewAll=!0),this.boardView.setDebugState(this.debugViewAll,this.debugEditMode),this.boardView.render(this.game,this)}switchToCompass(){this.boardView.hide(),this.selectionView.hide(),this.compassView.show()}handleGoBack(){this.boardView.hide(),this.selectionView.show()}switchToBoard(){this.compassView.hide(),this.boardView.show(),this.gameState&&this.gameState.is&&this.gameState.is(b.SELECTING_PLAYERS)&&this.selectionView.show(),this.boardView.render(this.game,this)}async _handleBlueRabbitClick(){await this._handlePlayerClick(g.BLUE_RABBIT)}async _handleYellowMouseClick(){await this._handlePlayerClick(g.YELLOW_MOUSE)}async _handleGreenRabbitClick(){await this._handlePlayerClick(g.GREEN_RABBIT)}async _handleRedMouseClick(){await this._handlePlayerClick(g.RED_MOUSE)}async _handlePlayerClick(e){if(!this._onInterruption()){if(this.gameState.is(b.SELECTING_PLAYERS)){await this._handleSelectPlayer(e);return}if(this.gameState.is(b.SELECTING_FIRST_PLAYER)){await this._handleSelectFirstPlayer(e);return}if(this.gameState.isPlaying()){await this.game.givePlayerPosition(e);return}}}async _handleSelectPlayer(e){await this.game.addPlayer(e)&&this.compassView.togglePlayerLightOn(e)}async _handleSelectFirstPlayer(e){await this.game.setFirstPlayer(e)&&(this.compassView.togglePlayerLightOn(e),await this.gameState.startGame())}async _handleNorthClick(){await this._handleDirectionClick(f.NORTH)}async _handleEastClick(){await this._handleDirectionClick(f.EAST)}async _handleSouthClick(){await this._handleDirectionClick(f.SOUTH)}async _handleWestClick(){await this._handleDirectionClick(f.WEST)}async _handleDirectionClick(e){if(!this._onInterruption()&&!this.gameState.isOver()){if(!this.gameState.isPlaying()){this.narrator.selectPlayers();return}this.compassView.togglePlayerLightOff(this.game.currentPlayer),await this.game.moveCurrentPlayer(e),this.game.isOver()||this.compassView.togglePlayerLightOn(this.game.currentPlayer)}}async _handleHelpClick(){if(!this._onInterruption()){if(this.gameState.is(b.SELECTING_PLAYERS)){await this.gameState.selectFirstPlayer()&&this.compassView.togglePlayerLightsOff();return}this.gameState.is(b.SELECTING_FIRST_PLAYER)||this.gameState.isPlaying()&&(this.compassView.togglePlayerLightOff(this.game.currentPlayer),await this.game.giveHint(),this.game.isOver()||this.compassView.togglePlayerLightOn(this.game.currentPlayer))}}async _handleHelpLongPress(){if(!this._onInterruption()&&!this.gameState.isOver()){if(!this.gameState.isPlaying()){this.narrator.selectPlayers();return}this.game.previousPlayer&&(this.compassView.togglePlayerLightOff(this.game.currentPlayer),this.compassView.togglePlayerLightOn(this.game.previousPlayer),await this.narrator.replayLastTurn(),this.compassView.togglePlayerLightOff(this.game.previousPlayer),this.compassView.togglePlayerLightOn(this.game.currentPlayer))}}_onInterruption(){return this.narrator.interrupt()}}const T=document.getElementById("play-btn"),M=document.getElementById("language-select"),J=document.getElementById("difficulty-select"),B=document.getElementById("language-label"),I=document.getElementById("difficulty-label");function G(){const l=M.value,e=N[l];e&&T&&(T.textContent=e.play),e&&B&&(B.textContent=e.language_label),e&&I&&(I.textContent=e.difficulty_label)}M&&(M.addEventListener("change",G),G());T&&T.addEventListener("click",async()=>{const l=M.value,e=J.value,t=new D,i=new F(t,N,l),a=new U(e,i),s=new z("compass-container"),r=new j("selection-container"),o=new K("board-container"),n=new Z(a,o,r,s,i);n.init(),await n.start()});</script>
  <style rel="stylesheet" crossorigin>body{margin:0;padding:20px 0 0;background-color:#222;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;font-family:sans-serif}.game-container{display:flex;flex-direction:column;align-items:center}.board{display:grid;grid-template-columns:repeat(9,auto);grid-template-rows:repeat(9,auto);background-color:#333;padding:20px;border-radius:10px;box-shadow:0 0 20px #00000080;position:relative}.board.edit-mode{border:3px solid #FFC107}.tile{width:100px;height:100px;background-color:#8b4513;position:relative;display:flex;justify-content:center;align-items:center}.tile img{width:80%;height:80%;object-fit:contain;border-radius:10%}.tile.flipped{transform:rotate(180deg)}.tile[data-row="0"][data-col="0"]{background-color:#4caf50}.tile[data-row="0"][data-col="3"]{background-color:#f44336}.tile[data-row="3"][data-col="0"]{background-color:#2196f3}.tile[data-row="3"][data-col="3"]{background-color:#ffeb3b}.wall{background-color:#555;cursor:pointer;transition:background-color .2s;display:flex;justify-content:center;align-items:center;position:relative;z-index:5}.wall.hidden-wall{background-color:transparent;cursor:default}.wall.hidden-wall.editable{border:1px dashed #777;cursor:pointer}:root{--wall-thickness: 15px}.wall.external{background-color:#888;cursor:default;pointer-events:none}.wall.horizontal{width:100%;height:var(--wall-thickness)}.wall.vertical{width:var(--wall-thickness);height:100%}.wall[data-type=no_wall]{background-color:transparent}.wall[data-type=no_wall]:hover{background-color:#0000001a}.wall[data-type=mouse_hole]{background-color:#ddd}.wall[data-type=mouse_hole]:after{content:"üê≠";font-size:16px}.wall[data-type=rabbit_window]{background-color:#ddd}.wall[data-type=rabbit_window]:after{content:"üê∞";font-size:16px}.wall[data-type=wall]{background-color:#555}.wall[data-type=wall]:after{content:"‚ùå";color:red;font-size:14px}.wall[data-type=free_passage]{background-color:#ddd}.wall[data-type=free_passage]:after{content:"‚úÖ";color:green;font-size:14px}.wall[data-type=magic_door]{background-color:#8b4513;border:1px solid #5d2e0c}.wall[data-type=magic_door]:after{content:"üö™";font-size:14px}.wall[data-type=magic_door].open{background-color:sienna}.wall[data-type=magic_door].open:after{content:"üö™";opacity:.5;transform:perspective(100px) rotateY(-45deg)}.corner{background-color:#333;width:var(--wall-thickness);height:var(--wall-thickness)}.sprite-1{background-position:0% 0%}.sprite-2{background-position:100% 0%}.sprite-3{background-position:0% 100%}.sprite-4{background-position:100% 100%}.player-token{position:absolute;width:30px;height:30px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:18px;border:2px solid white;box-shadow:0 2px 4px #0000004d;cursor:pointer;z-index:10;transition:transform .2s}.player-token:hover{transform:scale(1.2)}.player-token.selected{box-shadow:0 0 0 3px #fff,0 0 0 6px #2196f3;z-index:20}.player-token.green{background-color:#4caf50}.player-token.red{background-color:#f44336}.player-token.blue{background-color:#2196f3}.player-token.yellow{background-color:#ffeb3b}.player-token.small{width:20px;height:20px;font-size:12px;border-width:1px}.player-token.pos-top-left{top:5px;left:5px}.player-token.pos-top-right{top:5px;right:5px}.player-token.pos-bottom-left{bottom:5px;left:5px}.player-token.pos-bottom-right{bottom:5px;right:5px}.selection-screen{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 25px #0003;text-align:center;z-index:100;max-width:400px;width:90%}.player-options{display:flex;flex-direction:column;gap:10px;margin:20px 0;text-align:left}.option-row{display:flex;align-items:center;gap:10px}.option{flex-grow:1;padding:10px;border-radius:5px;cursor:pointer;transition:background .2s}.option:hover{background-color:#f5f5f5}.option.green{border-left:5px solid #4CAF50}.option.red{border-left:5px solid #F44336}.option.blue{border-left:5px solid #2196F3}.option.yellow{border-left:5px solid #FFEB3B}.first-select{display:flex;align-items:center;gap:5px;font-size:14px;cursor:pointer}.error{color:red;margin-bottom:15px;font-weight:700}#start-btn{padding:10px 20px;background-color:#2196f3;color:#fff;border:none;border-radius:5px;font-size:16px;cursor:pointer}#start-btn:hover{background-color:#1976d2}.turn-info{margin-bottom:10px;font-size:18px;background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 5px #0000001a}.message-box{position:fixed;top:20px;left:50%;transform:translate(-50%);background-color:#000c;color:#fff;padding:10px 20px;border-radius:20px;z-index:1000;min-height:20px;font-weight:700}.ghost-npc{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2em;z-index:15;pointer-events:none;animation:float 2s ease-in-out infinite}@keyframes float{0%{transform:translate(-50%,-50%)}50%{transform:translate(-50%,-60%)}to{transform:translate(-50%,-50%)}}.debug-panel{display:flex;gap:10px;margin-bottom:10px;padding:5px;background:#2b2b2be6;border-radius:8px;box-shadow:0 2px 5px #0000004d}.debug-btn{background:#444;border:1px solid #666;color:#eee;font-size:1.2em;padding:5px 10px;border-radius:4px;cursor:pointer;transition:all .2s}.debug-btn:hover{background:#555;transform:scale(1.05)}.debug-btn.active{background:#2196f3;border-color:#64b5f6;box-shadow:0 0 5px #2196f3}.hidden{display:none!important}#compass-container{display:flex;justify-content:center;align-items:center;width:100%}.magic-compass-wrapper{position:relative;display:inline-block}.magic-compass{position:relative}.compass-bg{max-height:80vh;max-width:100%;display:block;border-radius:20px;box-shadow:0 10px 30px #00000080}.compass-btn{position:absolute;cursor:pointer;border-radius:50%;background:transparent;z-index:10}.compass-btn:active{background:#ffffff80;box-shadow:0 0 15px #ffffff80}.help-btn{top:69%;left:42.5%;width:12%;height:10%;border-radius:50%}.cardinal-btn{width:9%;height:12%;border-radius:0;clip-path:polygon(50% 0%,0% 100%,100% 100%)}.north-btn{top:56%;left:44%;transform:rotate(0)}.east-btn{transform:rotate(90deg);left:60.5%;top:68.5%}.south-btn{transform:rotate(180deg);left:44%;top:81%}.west-btn{transform:rotate(270deg);left:28%;top:68.5%}.animal-btn{width:9%;height:7%;border-radius:50%}.green-rabbit-btn{top:61.2%;left:30.5%}.red-mouse-btn{top:61%;left:57.5%}.blue-rabbit-btn{top:81.3%;left:31%}.yellow-mouse-btn{top:81%;left:57.5%}.invisible-nav-btn{position:absolute;top:0;left:0;width:50px;height:50px;background:transparent;cursor:default;z-index:1000}.go-back-btn{margin-top:10px;padding:8px 16px;background-color:#f44336;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:14px;transition:background-color .2s}.go-back-btn:hover{background-color:#d32f2f}.compass-light{position:absolute;width:20px;height:20px;border-radius:50%;background-color:#300;box-shadow:inset 0 0 5px #000;transition:all .3s;z-index:20;pointer-events:none}.compass-light.on{background-color:red;box-shadow:0 0 10px red,0 0 20px red}.light-top-left{top:57%;left:24%}.light-top-right{top:56.5%;left:68%}.light-bottom-left{top:89%;left:25%}.light-bottom-right{top:89%;left:68%}.start-popup{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000000e6;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px;z-index:2000}.settings-group{display:flex;flex-direction:column;align-items:center;gap:8px;color:#fff}.settings-group label{font-size:1.2em;font-weight:700;color:#ffc107}.settings-group select{padding:10px 20px;font-size:1.1em;background:#333;color:#fff;border:2px solid #555;border-radius:8px;cursor:pointer;min-width:200px}.settings-group select:hover{border-color:#ffc107}.settings-group select:focus{outline:none;border-color:#ffc107;box-shadow:0 0 10px #ffc1074d}.start-popup.hidden{display:none}#play-btn{padding:20px 40px;font-size:2em;background-color:#4caf50;color:#fff;border:none;border-radius:10px;cursor:pointer;box-shadow:0 0 20px #4caf5080;transition:transform .2s,box-shadow .2s}#play-btn:hover{transform:scale(1.1);box-shadow:0 0 30px #4caf50cc}.narrator-message-container{width:90%;max-width:600px;box-sizing:border-box;background:#000c;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);color:#fff;padding:15px 25px;border-radius:15px;border:1px solid rgba(255,255,255,.1);box-shadow:0 4px 15px #0000004d;z-index:100;text-align:center;font-size:.8em;font-weight:500;margin-top:20px;transition:opacity .3s,transform .3s;opacity:0;transform:translateY(10px);pointer-events:none;min-height:3em;max-height:30vh;overflow-y:auto;word-wrap:break-word;overflow-wrap:break-word;display:flex;flex-direction:column;justify-content:center}.narrator-message-container.active{opacity:1;transform:translateY(0);pointer-events:auto}.narrator-message-container .source{font-weight:700;color:#ffc107;text-transform:uppercase;font-size:.85em;margin-bottom:4px;display:block}</style>
</head>

<body>

    <div id="start-popup" class="start-popup">
        <div class="settings-group">
            <label for="language-select" id="language-label"></label>
            <select id="language-select">
                <option value="en">English</option>
                <option value="es">Espa√±ol</option>
            </select>
        </div>
        <div class="settings-group">
            <label for="difficulty-select" id="difficulty-label"></label>
            <select id="difficulty-select">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
            </select>
        </div>
        <button id="play-btn"></button>
    </div>
    <div id="selection-container"></div>
    <div class="game-container">
        <div id="board-container">
            <!-- Board and Messages will be injected here -->
        </div>
        <div id="compass-container" class="hidden"></div>
        <div id="narrator-message-container" class="narrator-message-container"></div>
    </div>
</body>

</html>